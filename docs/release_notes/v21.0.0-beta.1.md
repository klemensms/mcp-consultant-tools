# Release v21.0.0-beta.1

**Release Date:** TBD
**Type:** Major Release (Breaking Changes)
**Status:** Beta Testing

## Overview

Version 21.0.0 simplifies the PowerPlatform security model by removing environment flag requirements and relying solely on package selection for security isolation. User testing confirms package isolation already provides sufficient security boundary.

## Breaking Changes

### PowerPlatform Security Model Simplification

**OLD (v16-20):** Two-layer security (package + environment flags)
```bash
# Both required
npm install @mcp-consultant-tools/powerplatform-customization
POWERPLATFORM_ENABLE_CUSTOMIZATION=true
```

**NEW (v21+):** Package-only security
```bash
# Just package installation
npm install @mcp-consultant-tools/powerplatform-customization
# No flags needed - installation = explicit intent
```

**Removed Environment Flags:**
- `POWERPLATFORM_ENABLE_CUSTOMIZATION` (powerplatform-customization package)

**Retained Environment Flags (Still Required):**
- `POWERPLATFORM_ENABLE_CREATE` (powerplatform-data package) - Granular control retained
- `POWERPLATFORM_ENABLE_UPDATE` (powerplatform-data package) - Granular control retained
- `POWERPLATFORM_ENABLE_DELETE` (powerplatform-data package) - Granular control retained

**Migration Required:**
1. Review package installations across all environments
2. Uninstall `powerplatform-customization` from production
3. Remove `POWERPLATFORM_ENABLE_CUSTOMIZATION` flag from `.env` files (optional cleanup)
4. **Keep data flags**: `POWERPLATFORM_ENABLE_CREATE/UPDATE/DELETE` are still required for data operations

**See:** [Migration Guide](/docs/MIGRATION_v21.md) for complete instructions.

### Packages Affected

- `@mcp-consultant-tools/powerplatform-customization` - No longer checks `POWERPLATFORM_ENABLE_CUSTOMIZATION`
- `@mcp-consultant-tools/powerplatform-data` - **Still requires** `POWERPLATFORM_ENABLE_CREATE/UPDATE/DELETE` flags
- `@mcp-consultant-tools/meta` - Updated comments for customization package

**Backward Compatibility:**
- Customization flag will be ignored (no errors)
- Data flags still required and checked (breaking if removed)
- No code changes required for users
- Configuration files will continue to work

## Why This Change?

**Problem:** The customization flag added redundant complexity on top of package isolation.

**Solution:** Remove customization flag, rely on package selection. Keep data flags for granular control.

**Benefits:**
- Simpler configuration for customization operations (no flag to set)
- Clearer mental model for schema changes (install package = grant access)
- Granular control retained for data operations (CREATE/UPDATE/DELETE flags preserved)
- Package isolation already proven through testing

**Security maintained:**
- Schema changes: Package installation = explicit intent
- Data operations: Granular flags provide fine-tuned control per operation type
- Production environments should only install the read-only `powerplatform` package

## Beta Testing Configuration

### Test 1: Read-Only Package (Production-Safe)
```json
{
  "mcpServers": {
    "powerplatform-readonly": {
      "command": "npx",
      "args": ["-y", "@mcp-consultant-tools/powerplatform@beta"],
      "env": {
        "POWERPLATFORM_URL": "https://dev-environment.crm.dynamics.com",
        "POWERPLATFORM_CLIENT_ID": "your-client-id",
        "POWERPLATFORM_CLIENT_SECRET": "your-client-secret",
        "POWERPLATFORM_TENANT_ID": "your-tenant-id"
      }
    }
  }
}
```

**Expected:** Read-only access works. No customization or data operations available.

### Test 2: Customization Package (No Flags)
```json
{
  "mcpServers": {
    "powerplatform-customization": {
      "command": "npx",
      "args": ["-y", "@mcp-consultant-tools/powerplatform-customization@beta"],
      "env": {
        "POWERPLATFORM_URL": "https://dev-environment.crm.dynamics.com",
        "POWERPLATFORM_CLIENT_ID": "your-client-id",
        "POWERPLATFORM_CLIENT_SECRET": "your-client-secret",
        "POWERPLATFORM_TENANT_ID": "your-tenant-id",
        "POWERPLATFORM_DEFAULT_SOLUTION": "TestSolution"
      }
    }
  }
}
```

**Expected:** All customization tools immediately available (no flag needed).

### Test 3: Data Package (With Granular Flags)
```json
{
  "mcpServers": {
    "powerplatform-data": {
      "command": "npx",
      "args": ["-y", "@mcp-consultant-tools/powerplatform-data@beta"],
      "env": {
        "POWERPLATFORM_URL": "https://dev-environment.crm.dynamics.com",
        "POWERPLATFORM_CLIENT_ID": "your-client-id",
        "POWERPLATFORM_CLIENT_SECRET": "your-client-secret",
        "POWERPLATFORM_TENANT_ID": "your-tenant-id",
        "POWERPLATFORM_ENABLE_CREATE": "true",
        "POWERPLATFORM_ENABLE_UPDATE": "true",
        "POWERPLATFORM_ENABLE_DELETE": "true"
      }
    }
  }
}
```

**Expected:** CRUD tools available based on flags set. All operations work with flags enabled.

### Test 4: Meta Package (All Integrations with Data Flags)
```json
{
  "mcpServers": {
    "mcp-consultant-tools": {
      "command": "npx",
      "args": ["-y", "@mcp-consultant-tools/meta@beta"],
      "env": {
        "POWERPLATFORM_URL": "https://dev-environment.crm.dynamics.com",
        "POWERPLATFORM_CLIENT_ID": "your-client-id",
        "POWERPLATFORM_CLIENT_SECRET": "your-client-secret",
        "POWERPLATFORM_TENANT_ID": "your-tenant-id",
        "POWERPLATFORM_ENABLE_CREATE": "true",
        "POWERPLATFORM_ENABLE_UPDATE": "true",
        "POWERPLATFORM_ENABLE_DELETE": "true"
      }
    }
  }
}
```

**Expected:** All PowerPlatform tools available (read + customization + data with flags).

### Test 5: Azure DevOps Variable Groups
```json
{
  "mcpServers": {
    "azure-devops": {
      "command": "npx",
      "args": ["-y", "@mcp-consultant-tools/azure-devops@beta"],
      "env": {
        // Required
        "AZUREDEVOPS_ORGANIZATION": "your-org",
        "AZUREDEVOPS_PAT": "your-personal-access-token",
        "AZUREDEVOPS_PROJECTS": "Project1,Project2",

        // Optional (defaults shown)
        "AZUREDEVOPS_API_VERSION": "7.1",
        "AZUREDEVOPS_ENABLE_WORK_ITEM_WRITE": "false",
        "AZUREDEVOPS_ENABLE_WORK_ITEM_DELETE": "false",
        "AZUREDEVOPS_ENABLE_WIKI_WRITE": "false"
      }
    }
  }
}
```

**Expected:**
- `list-variable-groups` returns all variable groups in project
- `get-variable-group` returns specific variable group with variables
- Secret values show as `***SECRET***`
- Project restriction still enforced

## Beta Testing Checklist

**Package Isolation:**
- [ ] Verify `powerplatform` package only exposes read-only tools
- [ ] Verify `powerplatform-customization` tools work without CUSTOMIZATION flag
- [ ] Verify `powerplatform-data` tools require CREATE/UPDATE/DELETE flags
- [ ] Verify delete operation still requires `confirm: true`

**Migration:**
- [ ] Test existing v20 config with all flags (should work)
- [ ] Test v21 config without CUSTOMIZATION flag (customization should work)
- [ ] Test v21 config without data flags (data operations should fail with clear error)
- [ ] Verify granular control: CREATE=true but DELETE=false works as expected

**Documentation:**
- [ ] Review updated README.md
- [ ] Review updated CLAUDE.md
- [ ] Review migration guide
- [ ] Review updated user documentation

**Security:**
- [ ] Confirm package selection provides sufficient isolation
- [ ] Verify production guidance is clear
- [ ] Test that credentials are still required

**Azure DevOps Variable Groups:**
- [ ] Verify `list-variable-groups` returns all groups in project
- [ ] Verify `get-variable-group` returns specific group by ID
- [ ] Confirm secret values are masked as `***SECRET***`
- [ ] Verify project allowlist (`AZUREDEVOPS_PROJECTS`) is enforced

## Changes to Existing Features

### PowerPlatform: Documentation Cleanup for Read-Only Package

**Improved documentation clarity** for the `@mcp-consultant-tools/powerplatform` (read-only) package to eliminate confusion about customization and data modification operations.

**Changes made:**
1. **Removed obsolete configuration flags** from all examples:
   - Removed `POWERPLATFORM_ENABLE_CUSTOMIZATION` (not applicable to read-only package)
   - Removed `POWERPLATFORM_DEFAULT_SOLUTION` (only needed for customization package)

2. **Removed CRUD operations section** from read-only package docs:
   - `create-record`, `update-record`, `delete-record` moved to powerplatform-data docs
   - Added clear pointer to separate package

3. **Added comprehensive warning** at top of Tools section:
   - Clear list of what IS included (40 read-only tools)
   - Clear list of what is NOT included (CRUD, schema changes)
   - Explicit instruction to ignore customization flags in docs

4. **Updated configuration section**:
   - Removed confusing "Enabling Customization" section (146 lines)
   - Clarified v21+ package-based security model
   - Configuration examples now show ONLY the 4 required variables

**Why this matters:**
- Users installing read-only package were confused by references to customization flags that don't apply
- Documentation incorrectly showed `POWERPLATFORM_ENABLE_CUSTOMIZATION=true/false` in examples
- Clearer separation between read-only, customization, and data packages reduces support overhead

**Files updated:**
- [docs/documentation/POWERPLATFORM.md](../../documentation/POWERPLATFORM.md)

### All Integrations: Documentation Standardization

**Comprehensive documentation update** across all integration guides to standardize configuration examples and clearly label required vs optional parameters.

**Changes made:**
1. **All configuration examples now show ALL available parameters** with inline comments
2. **Clear Required/Optional labels** in both JSON examples and environment variable tables
3. **Added environment variable tables** with Required/Default/Description columns
4. **Fixed incorrect environment variable names** in documentation:
   - GitHub Enterprise: `GITHUB_TOKEN` → `GHE_TOKEN`, `GITHUB_ENTERPRISE_URL` → `GHE_BASE_URL`
   - Application Insights: `APPLICATIONINSIGHTS_*` → `APPINSIGHTS_*`
5. **Added multi-resource configuration examples** where applicable (Log Analytics, SharePoint)
6. **Added alternative auth methods** where supported (Service Bus connection string, Figma OAuth)

**Files updated:**
- [docs/documentation/AZURE_DEVOPS.md](../../documentation/AZURE_DEVOPS.md)
- [docs/documentation/GITHUB_ENTERPRISE.md](../../documentation/GITHUB_ENTERPRISE.md)
- [docs/documentation/APPLICATION_INSIGHTS.md](../../documentation/APPLICATION_INSIGHTS.md)
- [docs/documentation/POWERPLATFORM.md](../../documentation/POWERPLATFORM.md)
- [docs/documentation/POWERPLATFORM_CUSTOMIZATION.md](../../documentation/POWERPLATFORM_CUSTOMIZATION.md)
- [docs/documentation/POWERPLATFORM_DATA.md](../../documentation/POWERPLATFORM_DATA.md)
- [docs/documentation/FIGMA.md](../../documentation/FIGMA.md)
- [docs/documentation/AZURE_SQL.md](../../documentation/AZURE_SQL.md)
- [docs/documentation/LOG_ANALYTICS.md](../../documentation/LOG_ANALYTICS.md)
- [docs/documentation/SERVICE_BUS.md](../../documentation/SERVICE_BUS.md)
- [docs/documentation/SHAREPOINT.md](../../documentation/SHAREPOINT.md)

## New Features

### Azure DevOps: Variable Groups Support

Added **two new tools** to access Azure DevOps variable groups (pipeline library variables):

- **`list-variable-groups`** - List all variable groups in a project
- **`get-variable-group`** - Get a specific variable group by ID

**What it provides:**
- Variable group metadata (name, description, type, created/modified info)
- All variables in the group with their values
- Secret masking (secrets show as `***SECRET***` for security)
- Sharing information (cross-project references)

**Use cases:**
- **Pipeline debugging** - See what variables are configured for your pipelines
- **Environment comparison** - Compare variable values across dev/staging/prod groups
- **Configuration auditing** - Verify expected variables exist and have correct values
- **Secrets inventory** - Identify which variables are marked as secrets

**Example:**
```javascript
// List all variable groups in a project
await mcpClient.invoke("list-variable-groups", {
  project: "MyProject"
});

// Get specific variable group
await mcpClient.invoke("get-variable-group", {
  project: "MyProject",
  groupId: 825
});
```

**Security:**
- Secret values are always masked in responses (`***SECRET***`)
- Read-only access (no modification operations)
- Respects `AZUREDEVOPS_PROJECTS` allowlist

**Package:** `@mcp-consultant-tools/azure-devops` (now 15 tools, 4 prompts)

### PowerPlatform: Action-Level Flow Execution Details

Added **`get-flow-run-details`** tool to retrieve detailed action-level execution information for Power Automate flows using the **Power Automate Management API**.

**What it provides:**
- Action-by-action execution status (Succeeded/Failed/Skipped)
- Per-action timing and duration
- Action-level error details for debugging
- Trigger execution information
- Links to inputs/outputs for each action
- Summary statistics (total actions, succeeded/failed/skipped counts)

**Use cases:**
- **Verify business logic execution** - "Did the Send Email action actually run?"
- **Debug conditional flows** - See which branch was taken, which actions were skipped
- **Analyze branching behavior** - Understand why certain actions didn't execute
- **Investigate action-level failures** - Get detailed error messages per action
- **Validate flow logic** - Confirm expected actions executed in the correct order

**Authentication:**
Uses Power Automate Management API (`https://management.azure.com`) with automatic environment ID extraction. No additional environment variables required beyond existing PowerPlatform credentials.

**Example:**
```javascript
// Step 1: Get recent flow runs
const runs = await mcpClient.invoke("get-flow-runs", {
  flowName: "Lead Notification Flow",
  maxRecords: 5
});

// Step 2: Get detailed action-level execution for specific run
await mcpClient.invoke("get-flow-run-details", {
  flowId: "12345678-1234-1234-1234-123456789012",
  runId: runs.runs[0].flowrunid
});
```

**Comparison:**
- **`get-flow-runs`** (Dataverse): High-level overview of multiple runs (statistics, monitoring)
- **`get-flow-run-details`** (Management API): Deep dive into single run (debugging, verification)

**Package:** `@mcp-consultant-tools/powerplatform` (read-only package)

## Support

Report issues at: https://github.com/klemensms/mcp-consultant-tools/issues
