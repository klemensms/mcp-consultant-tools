# Release v23.0.0-beta.3

**Release Date:** 2024-12-11
**Type:** Feature Release
**Status:** Beta Testing

## Overview

Version 23.0.0 adds major new features to the PowerPlatform MCP server:
1. **Interactive User Authentication** - Browser-based SSO for end users (no secrets needed on user machines)
2. **HTTP Transport** - Integration with ChatGPT and HTTP-based MCP clients
3. **Response Size Optimization** - New parameters to reduce tool response sizes and improve context efficiency

## Breaking Changes

None. Existing service principal authentication continues to work unchanged.

## New Features

### PowerPlatform: Interactive User Authentication (Browser SSO)

Added browser-based OAuth authentication, allowing users to authenticate with their own Entra ID credentials. This enables:

- **User-level security** - Dynamics security roles apply per user
- **SSO experience** - Enterprise users are already signed in
- **Simple rollout** - No client secrets on user machines
- **Audit trail** - All actions logged under user identity

**How It Works:**
- If `POWERPLATFORM_CLIENT_SECRET` is provided → Service Principal auth (existing behavior)
- If `POWERPLATFORM_CLIENT_SECRET` is NOT provided → Interactive browser auth (new)

**New Files:**
- `packages/powerplatform/src/auth/index.ts` - Auth provider factory
- `packages/powerplatform/src/auth/service-principal-auth.ts` - Service principal authentication
- `packages/powerplatform/src/auth/interactive-auth.ts` - Browser-based OAuth flow
- `packages/powerplatform/src/auth/token-cache.ts` - Encrypted token storage

**New Dependencies:**
- `open` ^10.1.0 - Opens browser for authentication

**New CLI Commands:**
- `npx @mcp-consultant-tools/powerplatform --help` - Show help message
- `npx @mcp-consultant-tools/powerplatform --logout` - Clear cached authentication tokens

**Token Caching:**
- Tokens are cached locally in `~/.mcp-consultant-tools/token-cache-{clientId}.enc`
- Encrypted with AES-256-GCM using machine-specific key
- Refresh tokens (~90 day lifetime) enable silent re-authentication
- Use `--logout` to clear cached tokens

**App Registration Requirements (for interactive auth):**
1. Enable "Allow public client flows" in Azure Portal → App Registration → Authentication
2. Add redirect URI: `http://localhost` (Mobile and desktop applications platform)
3. Add delegated permissions:
   - **Dynamics CRM** → `user_impersonation` (Required - admin consent needed)
   - Microsoft Graph → `offline_access` (Recommended - for token refresh)
   - Microsoft Graph → `User.Read` (Optional - for user info display)
4. **Grant admin consent** for all permissions (Required - without this, users see "Approval required" screen)

### PowerPlatform: HTTP Server for ChatGPT Integration

Added an HTTP server entry point (`http-server.ts`) that enables the PowerPlatform MCP server to be used with ChatGPT via ngrok or similar tunneling solutions.

**Key Features:**
- Uses `StreamableHTTPServerTransport` from MCP SDK (recommended transport)
- Session management for concurrent connections
- CORS headers for ChatGPT compatibility
- Health check endpoint at `/health`
- All 40 read-only tools + 11 prompts available via HTTP

**New Files:**
- `packages/powerplatform/src/http-server.ts` - HTTP server entry point

**New Dependencies:**
- `express` ^4.21.0
- `@types/express` ^4.17.21 (devDependency)

**New Commands:**
- `npm run start:http` - Start HTTP server on port 3000
- `mcp-pp-http` - Binary entry point for HTTP server

### PowerPlatform & PowerPlatform-Data: Response Size Optimization

Added new parameters across multiple tools to significantly reduce response sizes and improve context window efficiency. These changes address feedback about tools returning too much data.

**Query Records (`query-records`):**
- Added `select` parameter - specify exactly which columns to return
- Added `hasMore` indicator - shows when more records are available
- Response now includes: `value`, `hasMore`, `returnedCount`, `requestedMax`

```json
// Before: Returns ALL 200+ columns
{ "entityNamePlural": "accounts", "filter": "statecode eq 0" }

// After: Returns only specified columns
{ "entityNamePlural": "accounts", "filter": "statecode eq 0", "select": ["name", "accountid", "revenue"] }
```

**Get Entity Attributes (`get-entity-attributes`):**
- Added `prefix` filter - e.g., `si_` to get only custom columns
- Added `attributeType` filter - e.g., `Lookup`, `Picklist`, `String`
- Added `maxAttributes` limit
- Response now includes: `displayName`, `attributeType`, `requiredLevel`
- Added `hasMore` indicator

```json
// Before: Returns ALL 200+ attributes
{ "entityName": "contact" }

// After: Returns only custom columns
{ "entityName": "contact", "prefix": "si_", "maxAttributes": 50 }
```

**Get Flows (`get-flows`):**
- **Removed `clientdata` from listing** - was 50KB+ per flow, now only returned via `get-flow-definition`
- Reduced default `maxRecords` from 100 to 25
- Added `hasMore` indicator

**Get Flow Definition (`get-flow-definition`):**
- Added `summary` parameter (default: false)
- Summary mode returns parsed structure instead of full JSON:
  - Trigger type and name
  - Action list with types (no parameters)
  - Connector names used
  - Flags: `hasConditions`, `hasLoops`, `hasErrorHandling`

```json
// Full definition (default)
{ "flowId": "xxx-xxx" }

// Summary only - much smaller response
{ "flowId": "xxx-xxx", "summary": true }
```

**Get Workflows (`get-workflows`):**
- Reduced default `maxRecords` from 100 to 25
- Added `hasMore` indicator

**Get Workflow Definition (`get-workflow-definition`):**
- Added `summary` parameter (default: false)
- Summary mode parses XAML and returns structured data:
  - Activity counts by type (SendEmail, CreateEntity, etc.)
  - Variables list
  - Flags: `hasConditions`, `hasWaitConditions`, `sendsEmail`, etc.
  - XAML size indicator

```json
// Full XAML (default)
{ "workflowId": "xxx-xxx" }

// Summary only - much smaller response
{ "workflowId": "xxx-xxx", "summary": true }
```

**Impact:**
- `query-records` with `select`: **80-95% reduction** in response size
- `get-flows` listing: **~99% reduction** (removed clientdata)
- `get-flow-definition` summary: **90-95% reduction**
- `get-workflow-definition` summary: **95-99% reduction** (XAML is very verbose)
- `get-entity-attributes` with prefix: **50-90% reduction** depending on entity

## Bug Fixes

### Azure DevOps: Comments API Version Fix

Fixed `add-work-item-comment` and `get-work-item-comments` tools failing with error:
```
"The requested version \"7.1\" of the resource is under preview.
The -preview flag must be supplied in the api-version for such requests."
```

**Root Cause:** The Work Item Comments API in Azure DevOps has not reached GA status and requires `7.1-preview` instead of `7.1`.

**Fix:** Both `getWorkItemComments` and `addWorkItemComment` now use `api-version=7.1-preview` for the comments endpoints.

## Changes to Existing Features

- Added `express` as dependency to `@mcp-consultant-tools/powerplatform`
- Added `start:http` script to package.json
- Added `mcp-pp-http` binary entry point
- Azure DevOps comments endpoints now use `7.1-preview` API version

## Beta Testing Configuration

### Interactive User Authentication (NEW)

**Claude Desktop Config (Interactive Auth):**
```json
{
  "mcpServers": {
    "powerplatform": {
      "command": "npx",
      "args": ["-y", "@mcp-consultant-tools/powerplatform@beta"],
      "env": {
        "POWERPLATFORM_URL": "https://yourorg.crm.dynamics.com",
        "POWERPLATFORM_CLIENT_ID": "your-client-id",
        "POWERPLATFORM_TENANT_ID": "your-tenant-id"
      }
    }
  }
}
```

**Note:** No `POWERPLATFORM_CLIENT_SECRET` → triggers interactive browser auth on first tool call.

**Claude Desktop Config (Service Principal - Existing):**
```json
{
  "mcpServers": {
    "powerplatform": {
      "command": "npx",
      "args": ["-y", "@mcp-consultant-tools/powerplatform@beta"],
      "env": {
        "POWERPLATFORM_URL": "https://yourorg.crm.dynamics.com",
        "POWERPLATFORM_CLIENT_ID": "your-client-id",
        "POWERPLATFORM_CLIENT_SECRET": "your-client-secret",
        "POWERPLATFORM_TENANT_ID": "your-tenant-id"
      }
    }
  }
}
```

**CLI Testing:**
```bash
# Test interactive auth
export POWERPLATFORM_URL=https://yourorg.crm.dynamics.com
export POWERPLATFORM_CLIENT_ID=your-client-id
export POWERPLATFORM_TENANT_ID=your-tenant-id
npx @mcp-consultant-tools/powerplatform@beta

# Clear cached tokens
npx @mcp-consultant-tools/powerplatform@beta --logout

# Show help
npx @mcp-consultant-tools/powerplatform@beta --help
```

### PowerPlatform HTTP Server (ChatGPT POC)

**Terminal 1 - Start HTTP Server:**
```bash
cd packages/powerplatform
npm run start:http
# Output: PowerPlatform MCP HTTP server running on http://localhost:3000/mcp
```

**Terminal 2 - Expose via ngrok:**
```bash
ngrok http 3000
# Output: Forwarding https://abc123.ngrok-free.app -> http://localhost:3000
```

**ChatGPT Setup:**
1. Settings → Connectors → Create
2. Name: "Dynamics CRM"
3. MCP Server URL: `https://abc123.ngrok-free.app/mcp`
4. Authentication: None
5. Test: "Show me my top 10 accounts from CRM"

**Environment Variables (same as stdio server):**
```
POWERPLATFORM_URL=https://yourorg.crm.dynamics.com
POWERPLATFORM_CLIENT_ID=your-client-id
POWERPLATFORM_CLIENT_SECRET=your-client-secret
POWERPLATFORM_TENANT_ID=your-tenant-id
```

### Azure DevOps (Bug Fix)

**Claude Desktop Config:**
```json
{
  "mcpServers": {
    "azure-devops": {
      "command": "npx",
      "args": ["-y", "@mcp-consultant-tools/azure-devops@beta"],
      "env": {
        "AZUREDEVOPS_ORGANIZATION": "your-org",
        "AZUREDEVOPS_PAT": "your-pat",
        "AZUREDEVOPS_PROJECTS": "YourProject",
        "AZUREDEVOPS_ENABLE_WORK_ITEM_WRITE": "true"
      }
    }
  }
}
```

## Beta Testing Checklist

### Response Size Optimization ✅ TESTED (beta.3)
- [x] `query-records` with `select` parameter limits returned columns
- [x] `get-entity-attributes` with `prefix` filter returns only matching attributes
- [x] `get-entity-attributes` with `attributeType` filter works
- [x] `get-flows` returns listing without clientdata (much smaller)
- [x] `get-flow-definition` with `summary=true` returns parsed summary
- [x] `get-workflow-definition` with `summary=true` returns parsed summary
- [x] `hasMore` indicator appears when results are truncated
- [x] All tools work without new parameters (backward compatible)

### Azure DevOps Comments Fix
- [ ] `get-work-item-comments` returns comments without API version error
- [ ] `add-work-item-comment` creates comment successfully (requires ENABLE_WORK_ITEM_WRITE=true)
- [ ] Existing work item tools still function correctly

### Interactive User Authentication ✅ TESTED
- [x] Service principal mode still works (with secret)
- [x] Interactive mode triggers when no secret provided
- [x] Browser opens on first run
- [x] SSO works (no manual password entry for enterprise users)
- [x] Token is cached after successful auth
- [x] Subsequent runs use cached token (no browser)
- [x] Token refresh works when access token expires
- [x] `--logout` clears cache
- [x] User's Dynamics security role is respected
- [x] Different users on same machine have separate caches

### HTTP Server
- [ ] HTTP server starts without errors (`npm run start:http`)
- [ ] Health check endpoint returns OK (`curl http://localhost:3000/health`)
- [ ] ngrok tunnel works correctly
- [ ] ChatGPT can connect to MCP endpoint
- [ ] Tool calls work (e.g., list entities, query records)
- [ ] Session management works for concurrent connections
- [ ] Existing stdio server still works (`mcp-pp`)

## Security Notes

### Interactive User Authentication
- Tokens are encrypted at rest using AES-256-GCM
- Encryption key derived from machine-specific data (hostname + username)
- Tokens stored in `~/.mcp-consultant-tools/` with 600 permissions
- No client secrets on user machines
- User's Dynamics security roles apply (principle of least privilege)
- All operations logged under user's identity in Dynamics audit trail

### HTTP Server (POC)
This HTTP server is **POC only** and not production-ready:
- No authentication on HTTP endpoint
- Service account credentials in environment variables
- Anyone with ngrok URL can access

For production: Would need OAuth 2.0 flow with per-user Entra ID authentication.

## Support

Report issues at: https://github.com/klemensms/mcp-consultant-tools/issues
